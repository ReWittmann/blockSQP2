import numpy as np
import os
import sys
import time
import copy
try:
    sys.path.append(os.path.dirname(os.path.abspath(__file__)) + "/..")
except:
    sys.path.append(os.getcwd() + "/..")

import py_blockSQP
import matplotlib.pyplot as plt

itMax = 100
step_plots = False
# step_plots = True
plot_title = True


import OCProblems
#Available problems:
# ['Lotka_Volterra_Fishing', 'Lotka_Volterra_multimode', 'Goddard_Rocket', 
#  'Calcium_Oscillation', 'Batch_Reactor', 'Bioreactor', 'Hanging_Chain', 
#  'Hanging_Chain_NQ', 'Catalyst_Mixing', 'Cushioned_Oscillation', 
#  'D_Onofrio_Chemotherapy', 'D_Onofrio_Chemotherapy_VT', 'Egerstedt_Standard', 
#  'Fullers', 'Electric_Car', 'F8_Aircraft', 'Gravity_Turn', 'Oil_Shale_Pyrolysis', 
#  'Particle_Steering', 'Quadrotor_Helicopter', 'Supermarket_Refrigeration', 
#  'Three_Tank_Multimode', 'Time_Optimal_Car', 'Van_der_Pol_Oscillator', 
#  'Van_der_Pol_Oscillator_2', 'Van_der_Pol_Oscillator_3',
#  'Lotka_OED', 'Fermenter', 'Batch_Distillation', 'Hang_Glider', 'Cart_Pendulum']

OCprob = OCProblems.Rocket_Landing(nt = 35, 
                    refine = 1,
                    parallel = True, 
                    integrator = 'rk4', 
                    # epsilon = 100.0,
                    # lambda_u = 0.05, u_max = 15
                    # hT = 75.0
                    objective = "max_performance"
                    )

#Bad local optimum
# for i in range(22,24):
#     OCprob.set_stage_control(OCprob.start_point, i, 15)
# for i in range(25,35):
#     OCprob.set_stage_control(OCprob.start_point, i, -15)

################################
opts = py_blockSQP.SQPoptions()
opts.max_QP_it = 10000
opts.max_QP_secs = 5.0

opts.max_conv_QPs = 4
opts.conv_strategy = 2
opts.par_QPs = False
opts.enable_QP_cancellation=True
opts.test_opt_2 = 3

opts.exact_hess = 0
opts.hess_approx = 1
opts.sizing = 2
opts.fallback_approx = 2
opts.fallback_sizing = 4
opts.BFGS_damping_factor = 1/3

opts.lim_mem = True
opts.mem_size = 20
opts.opt_tol = 1e-6
opts.feas_tol = 1e-6
opts.conv_kappa_max = 8.0

opts.automatic_scaling = True

opts.max_extra_steps = 10
opts.enable_premature_termination = True
opts.max_filter_overrides = 0

opts.qpsol = 'qpOASES'
QPopts = py_blockSQP.qpOASES_options()
QPopts.printLevel = 0
QPopts.sparsityLevel = 2
opts.qpsol_options = QPopts
################################

#Create condenser, chose SCQPmethod below to enable condensing
vBlocks = py_blockSQP.vblock_array(len(OCprob.vBlock_sizes))
cBlocks = py_blockSQP.cblock_array(len(OCprob.cBlock_sizes))
hBlocks = py_blockSQP.int_array(len(OCprob.hessBlock_sizes))
targets = py_blockSQP.condensing_targets(1)
for i in range(len(OCprob.vBlock_sizes)):
    vBlocks[i] = py_blockSQP.vblock(OCprob.vBlock_sizes[i], OCprob.vBlock_dependencies[i])
for i in range(len(OCprob.cBlock_sizes)):
    cBlocks[i] = py_blockSQP.cblock(OCprob.cBlock_sizes[i])
for i in range(len(OCprob.hessBlock_sizes)):
    hBlocks[i] = OCprob.hessBlock_sizes[i]
targets[0] = py_blockSQP.condensing_target(*OCprob.ctarget_data)
cond = py_blockSQP.Condenser(vBlocks, cBlocks, hBlocks, targets)



#Define blockSQP Problemspec
prob = py_blockSQP.Problemspec()
prob.nVar = OCprob.nVar
prob.nCon = OCprob.nCon

prob.f = lambda x: OCprob.f(x)
prob.grad_f = lambda x: OCprob.grad_f(x)
prob.g = lambda x: OCprob.g(x)
prob.make_sparse(OCprob.jac_g_nnz, OCprob.jac_g_row, OCprob.jac_g_colind)
prob.jac_g_nz = lambda x: OCprob.jac_g_nz(x)
prob.hess = OCprob.hess_lag

prob.set_blockIndex(OCprob.hessBlock_index)
prob.set_bounds(OCprob.lb_var, OCprob.ub_var, OCprob.lb_con, OCprob.ub_con)

prob.vblocks = vBlocks
# prob.cond = cond

# import copy
# sp = copy.copy(OCprob.start_point)
# OCprob.integrate_full(sp)
# prob.x_start = sp

prob.x_start = OCprob.start_point


#Gravity turn vT70, nt = 100, refine = 1 integrator = cvodes
# prob.x_start = np.array([2.73102384e-06, 3.08851894e+00, 9.80280577e-01, 1.06827492e+01,
#        1.17036919e-01, 4.25906899e-05, 1.91602316e-01, 3.08851894e+00,
#        1.94833272e-01, 1.05600690e+01, 8.57486798e-02, 5.78559376e-05,
#        4.98663282e-01, 3.08851894e+00, 3.84196375e-01, 1.03181531e+01,
#        9.56239295e-02, 8.06477450e-05, 7.79700983e-01, 3.08851894e+00,
#        3.25395829e-01, 1.01132619e+01, 9.47653319e-02, 1.10793059e-04,
#        1.07301679e+00, 3.08851894e+00, 3.31889197e-01, 9.90428208e+00,
#        9.68401962e-02, 1.51783846e-04, 1.36865687e+00, 3.08851894e+00,
#        3.21585552e-01, 9.70179012e+00, 9.82151817e-02, 2.06739048e-04,
#        1.66950844e+00, 3.08851894e+00, 3.15857028e-01, 9.50290522e+00,
#        9.98588132e-02, 2.80169427e-04, 1.97505163e+00, 3.08851894e+00,
#        3.09115111e-01, 9.30826549e+00, 1.01517021e-01, 3.77672410e-04,
#        2.28568528e+00, 3.08851894e+00, 3.02821836e-01, 9.11758843e+00,
#        1.03262883e-01, 5.06419900e-04, 2.60157730e+00, 3.08851894e+00,
#        2.96611732e-01, 8.93082167e+00, 1.05086010e-01, 6.75431887e-04,
#        2.92298000e+00, 3.08851894e+00, 2.90571151e-01, 8.74785847e+00,
#        1.06996712e-01, 8.95999209e-04, 3.25014849e+00, 3.08851894e+00,
#        2.84644342e-01, 8.56862719e+00, 1.08995128e-01, 1.18214256e-03,
#        3.58335251e+00, 3.08851894e+00, 2.78859489e-01, 8.39303844e+00,
#        1.11089056e-01, 1.55114033e-03, 3.92287506e+00, 3.08851894e+00,
#        2.73232086e-01, 8.22099308e+00, 1.13288960e-01, 2.02410988e-03,
#        4.26903076e+00, 3.08851894e+00, 2.67741380e-01, 8.05240505e+00,
#        1.15602239e-01, 2.62660339e-03, 4.62215484e+00, 3.08851894e+00,
#        2.62358352e-01, 7.88720653e+00, 1.18031955e-01, 3.38931981e-03,
#        4.98259924e+00, 3.08851894e+00, 2.57134503e-01, 7.72529730e+00,
#        1.20593282e-01, 4.34881234e-03, 5.35074864e+00, 3.08851894e+00,
#        2.52034634e-01, 7.56659928e+00, 1.23294026e-01, 5.54816013e-03,
#        5.72702077e+00, 3.08851894e+00, 2.47056060e-01, 7.41103612e+00,
#        1.26143578e-01, 7.03767762e-03, 6.11185921e+00, 3.08851894e+00,
#        2.42207648e-01, 7.25852584e+00, 1.29155011e-01, 8.87552463e-03,
#        6.50574189e+00, 3.08851894e+00, 2.37505920e-01, 7.10897609e+00,
#        1.32346137e-01, 1.11281612e-02, 6.90919370e+00, 3.08851894e+00,
#        2.32897556e-01, 6.96232808e+00, 1.35723819e-01, 1.38707540e-02,
#        7.32277476e+00, 3.08851894e+00, 2.28450751e-01, 6.81848007e+00,
#        1.39314102e-01, 1.71872392e-02, 7.74709545e+00, 3.08851894e+00,
#        2.24081882e-01, 6.67738300e+00, 1.43123588e-01, 2.11702191e-02,
#        8.18281089e+00, 3.08851894e+00, 2.19861516e-01, 6.53894336e+00,
#        1.47180590e-01, 2.59204637e-02, 8.63062728e+00, 3.08851894e+00,
#        2.15735903e-01, 6.40310148e+00, 1.51500983e-01, 3.15459550e-02,
#        9.09131050e+00, 3.08851894e+00, 2.11753147e-01, 6.26976741e+00,
#        1.56116913e-01, 3.81604714e-02, 9.56569182e+00, 3.08851894e+00,
#        2.07827643e-01, 6.13890510e+00, 1.61040358e-01, 4.58819478e-02,
#        1.00546549e+01, 3.08851894e+00, 2.04027220e-01, 6.01043580e+00,
#        1.66307743e-01, 5.48301839e-02, 1.05591413e+01, 3.08851894e+00,
#        2.00269598e-01, 5.88433255e+00, 1.71935751e-01, 6.51241703e-02,
#        1.10801472e+01, 3.08851894e+00, 1.96596294e-01, 5.76054226e+00,
#        1.77959632e-01, 7.68791186e-02, 1.16187166e+01, 3.08851894e+00,
#        1.92999821e-01, 5.63901655e+00, 1.84416074e-01, 9.02025095e-02,
#        1.21759736e+01, 3.08851894e+00, 1.89424715e-01, 5.51974197e+00,
#        1.91332098e-01, 1.05190594e-01, 1.27530555e+01, 3.08851894e+00,
#        1.85832350e-01, 5.40272938e+00, 1.98729539e-01, 1.21925742e-01,
#        1.33511152e+01, 3.08851894e+00, 1.82255514e-01, 5.28796901e+00,
#        2.06648060e-01, 1.40472594e-01, 1.39713118e+01, 3.08851894e+00,
#        1.78649438e-01, 5.17547927e+00, 2.15118126e-01, 1.60874596e-01,
#        1.46148016e+01, 3.08851894e+00, 1.75002857e-01, 5.06528567e+00,
#        2.24172658e-01, 1.83151594e-01, 1.52827064e+01, 3.08851894e+00,
#        1.71282458e-01, 4.95743467e+00, 2.33838894e-01, 2.07298582e-01,
#        1.59760673e+01, 3.08851894e+00, 1.67467386e-01, 4.85198591e+00,
#        2.44140601e-01, 2.33284060e-01, 1.66958387e+01, 3.08851894e+00,
#        1.63601254e-01, 4.74897152e+00, 2.55120202e-01, 2.61049555e-01,
#        1.74428566e+01, 3.08851894e+00, 1.59595780e-01, 4.64847925e+00,
#        2.66787398e-01, 2.90510659e-01, 1.82177977e+01, 3.08851894e+00,
#        1.55508266e-01, 4.55056075e+00, 2.79173071e-01, 3.21559060e-01,
#        1.90211377e+01, 3.08851894e+00, 1.51331523e-01, 4.45527222e+00,
#        2.92300645e-01, 3.54063890e-01, 1.98531487e+01, 3.08851894e+00,
#        1.47084790e-01, 4.36265771e+00, 3.06194538e-01, 3.87874819e-01,
#        2.07138712e+01, 3.08851894e+00, 1.42790415e-01, 4.27274723e+00,
#        3.20879157e-01, 4.22825286e-01, 2.16031016e+01, 3.08851894e+00,
#        1.38464584e-01, 4.18556059e+00, 3.36374507e-01, 4.58736423e-01,
#        2.25203772e+01, 3.08851894e+00, 1.34145948e-01, 4.10109325e+00,
#        3.52704353e-01, 4.95421003e-01, 2.34649748e+01, 3.08851894e+00,
#        1.29834158e-01, 4.01934090e+00, 3.69878244e-01, 5.32687967e-01,
#        2.44359002e+01, 3.08851894e+00, 1.25653022e-01, 3.94022128e+00,
#        3.87946711e-01, 5.70344810e-01, 2.54319371e+01, 3.08851894e+00,
#        1.21519202e-01, 3.86370459e+00, 4.06907762e-01, 6.08203559e-01,
#        2.64516325e+01, 3.08851894e+00, 1.17543817e-01, 3.78969107e+00,
#        4.26797294e-01, 6.46079931e-01, 2.74933432e+01, 3.08851894e+00,
#        1.13759627e-01, 3.71806034e+00, 4.47654826e-01, 6.83798677e-01,
#        2.85552742e+01, 3.08851894e+00, 1.10146993e-01, 3.64870436e+00,
#        4.69499841e-01, 7.21195363e-01, 2.96354994e+01, 3.08851894e+00,
#        1.06780961e-01, 3.58146786e+00, 4.92380959e-01, 7.58117906e-01,
#        3.07320021e+01, 3.08851894e+00, 1.03594612e-01, 3.51623770e+00,
#        5.16306674e-01, 7.94428396e-01, 3.18426943e+01, 3.08851894e+00,
#        1.00751789e-01, 3.45279758e+00, 5.41366981e-01, 8.30002419e-01,
#        3.29654912e+01, 3.08851894e+00, 9.80936691e-02, 3.39103119e+00,
#        5.67567335e-01, 8.64729770e-01, 3.40983358e+01, 3.08851894e+00,
#        9.55756532e-02, 3.33085031e+00, 5.94888303e-01, 8.98518319e-01,
#        3.52391134e+01, 3.08851894e+00, 9.40407061e-02, 3.27163593e+00,
#        6.23781355e-01, 9.31279352e-01, 3.63861085e+01, 3.08851894e+00,
#        9.05624476e-02, 3.21461171e+00, 6.53055817e-01, 9.62962648e-01,
#        3.75369360e+01, 3.08851894e+00, 9.18720364e-02, 3.15676287e+00,
#        6.85371698e-01, 9.93492057e-01, 3.86905230e+01, 3.08851894e+00,
#        8.57034809e-02, 3.10279818e+00, 7.16277471e-01, 1.02285296e+00,
#        3.98443816e+01, 3.08851894e+00, 9.21132660e-02, 3.04479745e+00,
#        7.53177307e-01, 1.05097414e+00, 4.09983675e+01, 3.08851894e+00,
#        8.36722587e-02, 2.99211175e+00, 7.87049416e-01, 1.07783232e+00,
#        4.21513049e+01, 3.08851894e+00, 8.88881532e-02, 2.93614178e+00,
#        8.26201625e-01, 1.10343728e+00, 4.33013277e+01, 3.08851894e+00,
#        8.74210690e-02, 2.88109557e+00, 8.66473590e-01, 1.12772149e+00,
#        4.44498177e+01, 3.08851894e+00, 8.64206378e-02, 2.82667931e+00,
#        9.08102160e-01, 1.15070861e+00, 4.55954163e+01, 3.08851894e+00,
#        8.57122843e-02, 2.77270907e+00, 9.51229130e-01, 1.17241978e+00,
#        4.67371921e+01, 3.08851894e+00, 9.94670682e-02, 2.71007789e+00,
#        1.00565325e+00, 1.19273467e+00, 4.78802708e+01, 3.08851894e+00,
#        8.35816267e-02, 2.65744926e+00, 1.05129500e+00, 1.21169946e+00,
#        4.90240268e+01, 3.08851894e+00, 1.02251294e-01, 2.59306495e+00,
#        1.11209410e+00, 1.22932383e+00, 5.01696299e+01, 3.08851894e+00,
#        1.07274231e-01, 2.52551785e+00, 1.17899181e+00, 1.24544272e+00,
#        5.13266296e+01, 3.08851894e+00, 1.08971000e-01, 2.45690236e+00,
#        1.24982558e+00, 1.26006130e+00, 5.24986240e+01, 3.08851894e+00,
#        1.45747302e-01, 2.36513003e+00, 1.35208670e+00, 1.27296164e+00,
#        5.37012114e+01, 3.08851894e+00, 1.01498645e-01, 2.30121963e+00,
#        1.42336755e+00, 1.28427602e+00, 5.49349611e+01, 3.08851894e+00,
#        0.00000000e+00, 2.30121963e+00, 1.41461394e+00, 1.29503887e+00,
#        5.61507960e+01, 3.08851894e+00, 0.00000000e+00, 2.30121963e+00,
#        1.40649363e+00, 1.30592486e+00, 5.73140223e+01, 3.08851894e+00,
#        0.00000000e+00, 2.30121963e+00, 1.39892685e+00, 1.31692652e+00,
#        5.84250136e+01, 3.08851894e+00, 0.00000000e+00, 2.30121963e+00,
#        1.39185427e+00, 1.32803722e+00, 5.94840772e+01, 3.08851894e+00,
#        0.00000000e+00, 2.30121963e+00, 1.38523143e+00, 1.33925101e+00,
#        6.04914680e+01, 3.08851894e+00, 0.00000000e+00, 2.30121963e+00,
#        1.37902469e+00, 1.35056235e+00, 6.14474048e+01, 3.08851894e+00,
#        0.00000000e+00, 2.30121963e+00, 1.37320846e+00, 1.36196602e+00,
#        6.23520740e+01, 3.08851894e+00, 0.00000000e+00, 2.30121963e+00,
#        1.36776314e+00, 1.37345703e+00, 6.32056360e+01, 3.08851894e+00,
#        0.00000000e+00, 2.30121963e+00, 1.36267359e+00, 1.38503052e+00,
#        6.40082312e+01, 3.08851894e+00, 0.00000000e+00, 2.30121963e+00,
#        1.35792808e+00, 1.39668170e+00, 6.47599839e+01, 3.08851894e+00,
#        0.00000000e+00, 2.30121963e+00, 1.35351741e+00, 1.40840585e+00,
#        6.54610043e+01, 3.08851894e+00, 0.00000000e+00, 2.30121963e+00,
#        1.34943439e+00, 1.42019824e+00, 6.61113912e+01, 3.08851894e+00,
#        0.00000000e+00, 2.30121963e+00, 1.34567329e+00, 1.43205415e+00,
#        6.67112328e+01, 3.08851894e+00, 0.00000000e+00, 2.30121963e+00,
#        1.34222959e+00, 1.44396881e+00, 6.72606081e+01, 3.08851894e+00,
#        0.00000000e+00, 2.30121963e+00, 1.33909962e+00, 1.45593747e+00,
#        6.77595875e+01, 3.08851894e+00, 0.00000000e+00, 2.30121963e+00,
#        1.33628044e+00, 1.46795527e+00, 6.82082337e+01, 3.08851894e+00,
#        0.00000000e+00, 2.30121963e+00, 1.33376964e+00, 1.48001738e+00,
#        6.86066019e+01, 3.08851894e+00, 0.00000000e+00, 2.30121963e+00,
#        1.33156522e+00, 1.49211889e+00, 6.89547405e+01, 3.08851894e+00,
#        0.00000000e+00, 2.30121963e+00, 1.32966550e+00, 1.50425485e+00,
#        6.92526913e+01, 3.08851894e+00, 0.00000000e+00, 2.30121963e+00,
#        1.32806905e+00, 1.51642029e+00, 6.95004896e+01, 3.08851894e+00,
#        0.00000000e+00, 2.30121963e+00, 1.32677461e+00, 1.52861022e+00,
#        6.96981644e+01, 3.08851894e+00, 0.00000000e+00, 2.30121963e+00,
#        1.32578104e+00, 1.54081960e+00, 6.98457388e+01, 3.08851894e+00,
#        0.00000000e+00, 2.30121963e+00, 1.32508728e+00, 1.55304340e+00,
#        6.99432300e+01, 3.08851894e+00, 1.95454353e-02, 2.28891251e+00,
#        1.34047134e+00, 1.56513087e+00, 6.99910965e+01, 3.08851894e+00,
#        1.00000000e+00, 1.65924504e+00, 2.28700000e+00, 1.57079633e+00,
#        7.00000000e+01])



prob.lam_start = np.zeros(prob.nVar + prob.nCon, dtype = np.float64).reshape(-1)
prob.complete()

scale_arr = 1.0;
###SCALE###
# prob_unscaled = prob
# prob = py_blockSQP.scaled_Problemspec(prob)
# scale = py_blockSQP.double_array(OCprob.nVar)
# scale_arr = np.array(scale, copy = False)
# scale_arr[:] = 1.0
# for i in range(OCprob.ntS):
#     OCprob.set_stage_control(scale_arr, i, [0.001, 10.0,10.0])
# prob.arr_set_scale(scale)
#####################
stats = py_blockSQP.SQPstats("./solver_outputs")
#No condensing
tm1 = time.time()
optimizer = py_blockSQP.SQPmethod(prob, opts, stats)
optimizer.init()
#####################
t0 = time.time()
print("Created SQPmethod in ", t0 - tm1, "s\n")
if (step_plots):
    OCprob.plot(OCprob.start_point, dpi = 150, it = 0, title=plot_title)
    ret = int(optimizer.run(1))
    xi = np.array(optimizer.get_xi()).reshape(-1)/scale_arr
    i = 1
    OCprob.plot(xi, dpi = 150, it = i, title=plot_title)
    # OCprob.plot(xi, dpi = 200, it = i, title=False)
    while ret == 0 and i < itMax:
        ret = int(optimizer.run(1,1))
        xi = np.array(optimizer.get_xi()).reshape(-1)/scale_arr
        i += 1
        OCprob.plot(xi, dpi = 150, it = i, title=plot_title)
        # OCprob.plot(xi, dpi = 200, it = i, title=False)
else:
    ret = int(optimizer.run(itMax))
    xi = np.array(optimizer.get_xi()).reshape(-1)/scale_arr
t1 = time.time()
OCprob.plot(xi, dpi=150, title=plot_title)
#####################
time.sleep(0.01)
print(t1 - t0, "s")