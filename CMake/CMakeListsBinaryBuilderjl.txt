cmake_minimum_required(VERSION 3.20)

if(CMAKE_SOURCE_DIR STREQUAL CMAKE_BINARY_DIR)
  message(FATAL_ERROR "Please use out of source build:
  cmake -B build
  {make -C build } OR {cmake --build build}")
endif()

project(BinaryBuilderblockSQP2
	DESCRIPTION "Build system for blockSQP2 to be used in BinaryBuilder.jl."
	HOMEPAGE_URL https://github.com/ReWittmann/blockSQP2
    LANGUAGES CXX
	)
set(CMAKE_CXX_STANDARD 20)


# LAPACK/BLAS: Included via qpOASES
find_path(OPENBLAS_PREFIX
	include/cblas.h
	DOC "OpenBLAS directory prefix."
	REQUIRED
)
message(STATUS "Found path OPENBLAS_PREFIX: ${OPENBLAS_PREFIX}")

# Find dependencies: qpOASES
find_path(QPOASES_PREFIX
    include/qpOASES.hpp
    DOC "qpOASES directory prefix."
    REQUIRED
    )
message(STATUS "Found path QPOASES_PREFIX: ${QPOASES_PREFIX}")

find_library(QPOASES_LIBRARY
    qpOASES
    REQUIRED
    )

find_library(OPENBLAS_LIBRARY
	OpenBLAS
	REQUIRED
)

#As of right now, there are no export specifications ( __declspec(dllexport), __attribute__((visibility("default"))) )
#in the code, so static linking is recommended.
add_library(blockSQP2 STATIC
	blockSQP2/src/condensing.cpp
	blockSQP2/src/matrix.cpp
	blockSQP2/src/problemspec.cpp
	blockSQP2/src/general_purpose.cpp
	blockSQP2/src/glob.cpp
   	blockSQP2/src/hess.cpp
   	blockSQP2/src/iter.cpp
   	blockSQP2/src/method.cpp
   	blockSQP2/src/mainloop.cpp
   	blockSQP2/src/options.cpp
   	blockSQP2/src/qp.cpp
   	blockSQP2/src/restoration.cpp
   	blockSQP2/src/stats.cpp
   	blockSQP2/src/qpsolver.cpp
   	blockSQP2/src/defs.cpp
   	blockSQP2/src/scaling.cpp
   	blockSQP2/src/sqputils.cpp
	blockSQP2/src/load_mumps.cpp
   	)
target_compile_definitions(blockSQP2 PRIVATE QPSOLVER_QPOASES SOLVER_MUMPS BSQP_PAR_QPS_DISABLED BSQP_CBLAS_SUFFIX=${CBLAS_SUFFIX})

if (UNIX AND NOT APPLE)
	target_compile_definitions(blockSQP2 PUBLIC LINUX)
elseif(WIN32)
	target_compile_definitions(blockSQP2 PUBLIC WINDOWS)
endif()
target_compile_options(blockSQP2 PRIVATE 
	-Wall -Wextra -Wno-unused-parameter -Wno-maybe-uninitialized -fPIC
	)

set_target_properties(blockSQP2 PROPERTIES LIBRARY_OUTPUT_DIRECTORY ${CMAKE_SOURCE_DIR}/blockSQP2/bin
										   ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_SOURCE_DIR}/blockSQP2/lib
										   RUNTIME_OUTPUT_DIRECTORY ${CMAKE_SOURCE_DIR}/blockSQP2/bin
										   )
target_include_directories(blockSQP2 PUBLIC ${CMAKE_SOURCE_DIR}/blockSQP2/include 
											${QPOASES_PREFIX}/include
											)
target_link_libraries(blockSQP2 PUBLIC ${QPOASES_LIBRARY})
list(APPEND CMAKE_MODULE_PATH ${CMAKE_CURRENT_SOURCE_DIR})

#Build C interface to complete blockSQP.jl
add_library(blockSQP2_jl SHARED ${CMAKE_SOURCE_DIR}/C/CblockSQP2.cpp)
target_link_libraries(blockSQP2_jl PUBLIC blockSQP2)

target_compile_options(blockSQP2_jl PRIVATE 
			-Wall -Wextra -Wno-unused-parameter
			-fvisibility=hidden
			-fPIC
			)
set_target_properties(blockSQP2_jl PROPERTIES 
		LIBRARY_OUTPUT_DIRECTORY ${CMAKE_SOURCE_DIR}/blockSQP2.jl/bin
		RUNTIME_OUTPUT_DIRECTORY ${CMAKE_SOURCE_DIR}/blockSQP2.jl/bin
)

install(TARGETS blockSQP2_jl
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
    PUBLIC_HEADER DESTINATION ${CMAKE_INSTALL_INCLUDEDIR})